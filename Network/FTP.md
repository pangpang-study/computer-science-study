## FTP 서버

- FTP 서버는 TCP 기반 L5계층 파일 전송 프로토콜.
- 두 개의 TCP 세션으로 통신하는 것이 가장 큰 특징
    - 컨트롤(Control) 커넥션: 사용자 커맨드, 응답 패킷들이 통신하는 커넥션.
    - 데이터(Data) 커넥션: 파일 업로드, 다운로드와 같이 파일 정보를 주고 받는 커넥션 ex): RETR, STOR과 같은 명령어
- **커넥션이 2개이므로 데이터 전송중에도, 컨트롤 커넥션을 통해 데이터 전송을 제어**할 수 있다.
    - 하나의 클라이언트가 과도하게 트래픽을 사용하여 부하가 걸리는 경우, 컨트롤 커넥션으로 중단을 시키는 등 제어를 할 수 있다.
- 컨트롤 커넥션 연결 이후, 데이터 커넥션을 연결하는 방식은 크게 2가지로 나눌 수 있음.
    - Active
    - Passive

### Active Mode

- 서버가 클라이언트에게 데이터 커넥션 연결을 보내는 방식.
- 컨트롤 커넥션은 주로 21번 포트를 사용하고, 데이터 커넥션은 20번 포트를 사용.
- 연결 방식
    1. 컨트롤 커넥션은 연결되어 있다고 가정.
    2. 클라이언트 -> 서버: 컨트롤 커넥션을 통해 PORT 명령어 전달.
    3. 서버 -> 클라이언트: 데이터 커넥션 연결 요청
    4. 클라이언트 -> 서버: OK 연결 완료.

**문제점**
- Active 모드에서 서버 -> 클라이언트 요청시, 방화벽 또는 NAT에 의해 서버의 요청이 클라이언트에게 전달되지 않을 수 있다.

**해결책**
- 클라이언트가 방화벽 해제
- **Passive Mode** 사용
- 포트 포워딩

### Passive Mode

- 클라이언트가 서버에게 데이터 커넥션 연결을 보내는 방식.
- 컨트롤 커넥션은 21번을 동일하게 사용하고, 데이터 커넥션은 1024~65535번 포트중 하나를 사용.
- 연결 방식
    1. 컨트롤 커넥션은 연결되어 있다고 가정.
    2. 클라이언트 -> 서버: 컨트롤 커넥션을 통해 PASV 명령어 전달. 패시브 모드로 변경
    3. 서버 -> 클라이언트: 버는 랜덤한 포트(1024~65535)를 새로 오픈 -> 컨트롤 커넥션을 이용하여, 새로 오픈한 포트 번호를 응답.
    4. 클라이언트 -> 서버: 응답받은 포트로 데이터 커넥션 요청.
    5. 서버 -> 클라이언트: OK 연결 완료.

**문제점**
- 1024~65535포트의 인바운드를 허용해야 하므로, 해킹에 상대적으로 취약해진다.
- FTP 서버에서 위와 같은 이유로 아예 패시브 모드를 꺼놓는 경우가 있다.

**해결책**
- 특정 범위의 포트만 지정해서 허용하면 모든 포트 허용의 문제를 어느정도 해결



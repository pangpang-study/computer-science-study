
### 쓰레드와 병행성 제어

쓰레드 : cpu 이용의 기본 단위 
- 스레드 id , pc  레지스터 집합 , 스택으로 구성 
- 같은 프로세스에 속학 다른 스레드와 코드 , 데이터 , 운영체제 자원들을 공유 

전통적으로는 단일 스레드 프로세스로 작동했다면 최근의 많은 서비스는 다중스레드를 이용한다. 
서버를 예를 들었을 때 서버가 단일 스레드 프로세스라면 하나의 요청이 들어오면 새로운 프로세스를 만들었다. 

하지만 이것은 오버헤드도 크고 똑같은 일을 반복하게 될때에는 비효율 적이므로 프로세스를 생성하는 것이 아니라 요청일 들어오면 해당 요청을 처리할 새로운 스레드를 생성하는 것이고 다른 요청을  listen할 새로운 스레드를 생성하는 것이다. 

다중 스레드의 장점 
- 응답성 : 응용프로그램이 긴 작업을 수행하더라도 프로그램의 수행이 계속되는 것을 허용함으로써 사용자에 대한 응답성 증가 
- 자원 공유 : 프로세스는 공유 메모리와 메시지 전달 기법을 통하여 자원을 공유해야 하여 이를 프로그래머에 의해서 명시적으로 처리 되어야 ㅎ나다. 하지만 스레드는 그들이 속한 프로세스의 자원들과 메로리를 공유한다. 
- 경제성 : 새로운 프로세스를 위한 자우너할당이나 메모리의 비용이 줄고 프로세스 내에서 자원을 공유하기 때문에 문맥교환 또한 경제적이다. (셩험적으로 측정하는 것을 어렵다.)
- 규모 적응성 : 추후에 설명

점차 다중코어와 다중 스레드를 통한 프로그래밍은 효율적이지만 고려해야 하는 사항이  있다. 
'병행성' 과 '병렬성'
병행 시스템 : 모든 작업이 진행되게 하여 둘 이상의 작업을 지원
병렬 시스템 : 둘이상의 작업을 동시에 수행할 수 있다. 

원래 단일 프로세서에서는 프로세스간의 전환을 통해 병렬성의 환상을 제공하였고 병행하였지만 병렬되지 않았다. 

그럼 병렬되게 하려면? 다중 스레드를 사용하도록 설계해야 한다. 

[Amdahl's law]
순차 실행과 구성 요소과 병렬 실행 구성 요소로 이뤄진 성능 계산 공식 
쉽게 말하면 순차 실행관점에서는 코어의 수가 무한대에 가까워 질 수록 순차적으로 실행되어야 하는 부분을 성능향상에 불균형적인 영향을 미친다. 

극복과제 5가지
- 태스크 인식 : 분석하여 병행 가능 태스크로 나눌 수 있는 영역을 찾아야 한다. 
- 균현 : 병렬로 실행 될 수 있는 태스크를 찾는것만큼 전체 작업에 균등한 기여도를 가지도록 하는 것도 중요한다. 
- 데이터 분리 : 태스크가 접근하고 조작하는 데이터 또한 개별 코어에서 사용할 수 있어야 한다. 
- 데이터 종속성 : 태스크가 접근하는 데이터는 둘 이상의 태스크 사이에 종속적이지 않은 지 검토 필요 
- 시험 및 디버깅 : 병행 프로그램을 시험하고 디버깅 하는것 

다중 스레드 모델 
사용자 스레드 : 커널위에서 커널 지원 없이 관리된다. 
커널 스레드 : 운영체제에 의해 직접 지원되고 관리

두개의 스레드를 연관 짓는 3가지 모델 
- 다대일 모델 : 여러 사용자 스레드를 하나의 커널 스레드가 관리하는것 , 하지만 한번에 하나의 스레드 만이 커널에 접근할 수 있어 다중 스레드가 다중코어시스템에서 병렬로 실행 될 수 없다.  한 스레드가 봉쇄 시스템 콜을 하면 전체 프로세스가 봉쇄된다. 
- 일대일 모델 : 하나에 사용자 스레드에 하나의 커널 스레드 사상 , 더 많은 병렬성을 제공한다. 단점은 사용자 스레드를 만들려면 커널 스레드를 만들어야 한다. --> 시스템에 부담
- 다대다 모델 : 여러개의 사용자 수준 스레드를 그보다 작을 수 혹은 같은 수의 커널 스레드로 멀티 플렉스 한다. (4코어 보다는 8코어가 더 많은 커널 스레드 할당받기 가능)

다대일 --> 개발자가 원하는 만큼 사용자 스레드 생성 가능 , 하지만 커널스레드 하나라서 진정한 병렬실행 힘듦 <br>
일대일 --> 더 많은 병행 실행을 제공하지만 스레드가 너무 많이 생긴다. <br>
다대다 --> 위의 단점들을 상당 수 극복했지만 구현하기가 어렵다. <br>

다대다 모델이 융통성이 있어보이지만 코어수가 늘어갈 수록 커널 스레드의 수를 제한하는 것이 중요해졌다. 
따라서 대부분의 운영체제는 일대일 모델을 사용하고 일부 현대 병행 라이브러리가 개발자가 태스크를 식별해주면 다대다 모델을 사용하여 스레드 매핑을 한다. 

스레드 생성의 방법 
1. 비동기 스레딩 
2. 동기 스레딩 

동기 스레딩 : 부모 스레드가 하나 이상의 자식 스레드를 생성하고 모두 종료할 때까지 기다렸다가 자신의 실행을 재개하는 방식 
- 무보다 생성한 스레드는 병행 실행, 자식 스레드가 조인한 후에야 실행을 재개 


암묵정 스레딩 : 다중 코어 처리의 지속적 성장에 따라 수백 또는 심지어 수천개의 스레드를 가진 응용 등장
- 위의서 언급한 어려움을 극복하고 병행 및 병렬 응용의 설계를 도와주는 한가지 방법은 스레딩의 생성과 관리 책임을 개발자가 아니라 컴파일러, 라이브러리에게 넘겨주는 것이고 이를 암묵적 스레딩이라고 한다. 

스레드 풀 
- 새로운 스레드를 매 요청마다 만들어주는 것으느 그떄가마 새로운 프로세스를 만들어주는 것보다 확실히 더 진보된 방법이지만 , 다중 스레드 서버버는 서비스 할 때마다 스레드를 생성하는 데 소요되는 시간이 오래걸리고, 스레드는 이 일만 끝나면 곧장 페기 될것을 염두하면 더욱 중요하다. 
- 따라서 이러한 스레드를 최대개수, cpu시간 , 메모리 공산을 관리하는 방법 중 하나가 스레드 풀이다. 
- 스레드 풀 : 일정한 수의 스레드을 미리 풀로 만들어 두는 것이다. 
    - 스레드가 요펑이 들어오면 꺠어나고 즉시 서비스 된다 .완료하면 풀로 돌아가서 더 많은 작업을 기다린다. 
    - 따로 만드는 것보다 기존 스레드로 하는 것이 빠르다. 

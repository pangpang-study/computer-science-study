## Chapter 6. 동기화 도구들

## 이 장의 목표

- 임계구역 문제, 경쟁 조건
- 임계구역 문제에 대한 하드웨어 해결책(메모리 장벽, compare-and-swap)
- Mutex 락, 세마포어, 모니터 및 조건 변수를 사용해 임계 구역 문제 해결하는 방법
- 정도에 따른 경쟁 시나리오에서 임계구역 문제 해결하는 도구 평가

## 1.배경

- 경쟁 상황: 동시에 여러 개의 프로세스가 동일한 임계구역의 자료를 접근하여 조작하고, 그 실행 결과가 접근이 발생한 특정 순서에 의존하는 상황 → 한 순간에 하나의 프로세스만이 변수를 조작하도록 보장해야 함.
- 프로세스들이 동기화하도록 할 필요가 있음.

## 2. 임계구역 문제(The Critical-Section Problem)

- 각 프로세스는 임계구역이라고 부르는 코드 부분을 포함하고 있음.
- 임계 구역 안에서는 적어도 하나 이상의 다른 프로세스와 공유하는 데이터에 접근하고 갱신할 수 있음.
- 한 프로세스가 자신의 임계구역 안에서 수행되는 동안 다른 프로세스들은 그들의 임계 구역에 동시에 수행될 수 없음.
- 임계구역 문제: 프로세스들이 데이터를 협력적으로 공유하기 위해 자신들의 활동을 동기화할 때 사용할 수 있는 프로토콜을 설계하는 것.
    
    → 프로세스들간에 동기화하기 위한 규칙을 설계하는 것.
    

### 임계구역 문제에 대한 해결안이 충족해야 할 요구 조건

1. 상호 배제(mutual exclusion): 어떤 프로세스가 자신의 임계 구역에서 실행된다면, 다른 프로세스들은 그들 자신의 임계 구역에서 실행될 수 없음.
2. 진행(progress): 자기 임계 구역에서 실행되는 프로세스가 없고 그들 자신의 임계 구역으로 진입하려는 프로세스들이 있다면, 나머지 구역에서 실행 중이지 않은 프로세스들만 다음에 누가 그 임계 구역으로 진입할 수 있는지 결정하는 데 참여할 수 있으며, 이 선택은 무한정 연기될 수 없음.
3. 한정된 대기(bounded waiting): 프로세스가 자기 임계구역에 진입하려는 요청을 한 후부터 요청이 허용될 때까지 다른 프로세스들이 그들 자신의 임계구역에 진입하도록 허용되는 횟수에 한계가 있어야 함.

- 단일 코어 환경에서와 다중 코어 환경에서의 임계구역 문제 해결
- 선점형 커널과 비선점형 커널

## 3. Peterson의 해결안(Peterson’s Solution)

- 두 프로세스가 서로 turn과 flag 데이터를 공유하게 하는 소프트웨어적인 해결책.

### Peterson’s Solution은 최신 컴퓨터 아키텍처에서 작동한다고 보장되지 않음

- 다중 스레드 응용 프로그램: 시스템 성능 향상을 위해 프로세서나 컴파일러가 종속성 없는 읽기 및 쓰기 작업을 재정렬 할 수 있음. → 데이터 일관성이 깨지면서 두 스레드가 동시에 임계구역에서 활성화될 수도 있음. → 상호 배제가 지켜지지 않을 수도 있음!

## 4. 동기화를 위한 하드웨어 지원

## 5. Mutex Locks

- 임계구역 문제에 대한 하드웨어 기반 해결책은 복잡하며, 응용 프로그래머는 사용할 수 없음.
- Mutex Locks: 운영체제 설계자들이 임계구역 문제를 해결하기 위해 개발한 가장 간단한 상위 수준 소프트웨어 도구.
- 임계구역을 보호하고, 경쟁 조건을 방지하기 위해 임계 구역에 진입하기 전 락을 획득하고(acquire), 임계 구역을 벗어나면 반환함(release). → 다른 프로세스들은 락이 반환될 때까지 락을 획득하기 위해 회전. (spinlock 유형)
- spinlock: 프로세스가 락을 기다릴때 문맥 교환을 필요로 하지 않음.
- 락을 기다리는 스레드는 2번의 문맥 교환이 필요함. → 락이 유지되는 기간이 2번의 문맥 교환 시간보다 짧을 경우 스핀락을 사용함.
- 락이 반환될 때까지 다른 프로세스는 락을 획득하지 못하므로 임계 구역에 진입할 수 없음.
- 임계구역에 들어가 있지 않은 프로세스들은 busy waiting을 해야 하기 때문에 CPU 주기를 낭비하게 됨.(세마포어를 통해 극복하고자 함.)

## 6. 세마포어(Semaphores)

- mutex와 유사하게 동작하지만 프로세스들이 자신들의 행동을 더 정교하게 동기화할 수 있는 방법을 제공하는 강력한 동기화 도구.
- Semaphores: wait()과 signal() 연산만으로 접근할수 있는 정수 변수로, 사용가능한 자원의 개수로 초기화됨.(사용하면 -1(wait), 반납할때 +1(signal))
- mutex와 다르게 busy waiting 대신 프로세스 자신을 일시 정지시켜 세마포에 연관된 대기 큐에 넣고, 프로세스 상태를 대기 상태로 전환함. → 다른 프로세스가 signal 연산을 실행하면 wakeup 연산에 의해 재시작. → 프로세스 상태가 대기 상태에서 준비 완료 상태로 변경되고, 준비 완료 큐에 넣어짐.

### 세마포어의 원자적(atomic) 실행의 중요성

- 단일 처리기 환경: 같은 세마포어에 대해 두 프로세스가 동시에 wait() 연산과 signal() 연산을 실행할 수 없도록 보장해야 함. → 인터럽트를 금지함으로써 다른 프로세스의 명령어가 끼어들 수 없게 되고, 올바르게 작동함.
- 다중 코어 환경: 모든 처리 코어에서 인터럽트를 금지해야 함. → 다른 코어에서 실행되는 명령어들이 임의로 끼어들지 않게 하는 것. → 모든 코어를 금지하는 것은 매우 어려우며 성능을 심각하게 저하시킴.

## 7. 모니터

- 세마포어 또는 mutex 락을 이용해 임계구역 문제를 해결할 때 세마포어를 잘못 사용하면 다양한 유형의 오류가 생길 수 있음.
- Abstract data type, ADT: 데이터와 데이터를 조작하는 함수들의 집합을 하나의 단위로 묶어 보호하는 데이터 타입.
- 모니터 형: 오류를 처리하기 위해 제공하는 고급 언어 구조물 중 하나로, 모니터 내부에서 상호 배제가 보장되는 프로그래머가 정의한 일련의 연산자 집합을 포함하는 ADT.
- 모니터 형의 표현은 다른 프로세스들이 직접 사용할 수 없고, 모니터 내에 정의된 함수를 통해서만 접근 가능.

### 모니터 내에서 프로세스 수행 재개

- FCFS(First Come First Served) 순: 이렇게 간단한 스케줄링 기법은 충분하지 않음. → wait() 연산 호출 때 프로세스의 우선 순위를 나타내는 변수를 사용.

### 프로세스들이 올바른 순서를 지키도록 하기 위한 검사

- 모니터와 모니터가 관리하는 자원을 사용하는 모든 응용 프로그램을 검사해야함.
    - 프로세스들이 모니터를 정확한 순서에 맞춰 호출하는지 검사해야 함.
    - 비협조적인 프로세스가 액세스 제어 프로토콜을 사용하지 않아 모니터가 정한 상호 배제 규칙 경로를 무시하여 공유 자원을 직접 액세스하지 않는다는 것을 보장해야 함.
    
    → 시간 종속적인 오류 발생 없이 원하는 스케줄링이 지켜짐을 보장할 수 있음.
    
    - 규모가 큰 프로그램이나 동적인 시스템에서는 비합리적이라 추가적인 기법을 통해 해결할 수 있음.
    

## 8. 라이브니스(Liveness)

- 라이브니스: 프로세스가 실행 수명주기 동안 진행되는 것을 보장하기 위해 시스템이 충족해야 하는 속성들.
- 라이브니스 실패: 성능과 응답성이 나쁜 특징을 가짐.(ex: 무기한 대기하는 프로세스)

### 교착 상태(Deadlock)

- 한 집합 내의 모든 프로세스가 그 집합 내의 다른 프로세스만이 유발할 수 있는 이벤트(mutex lock이나 세마포어 같은 자원의 획득과 방출)을 기다리는 상황.

### 우선순위 역전(Priority Inversion)

- 셋 이상의 우선순위를 가진 시스템에서만 발생.
- 우선순위 오름차순 크기순으로 1, 2, 3인 프로세스에서 3의 세마포어 자원이 1에 의해 접근될 경우 1이 자원의 사용을 마칠 때까지 기다림. → 이 순간 2가 실행 가능 상태가 되고, 1을 2가 선점할 수 있을 경우, 3의 대기 시간은 2에 의해 영향을 받게 됨.
- 우선순위 상속 프로토콜(priority-inheritance protocol)을 구현하여 해결. → 더 높은 우선순위 프로세스가 필요로 하는 자원에 접근하는 모든 프로세스는 문제가 된 자원의 사용이 끝날 때까지 더 높은 우선순위를 상속받음.(1 → 2 → 3 이지만 일시적으로 1 → 3 → 2가 되는 꼴)
- 상속받은 우선순위는 자원의 사용을 마치면 방출됨.

## 9. 평가(Evaluation)

### 특정 동기화 도구를 사용할 시기를 결정하는 전략

- 동기화 도구는 다양한 경합 정도에 따라 평가할 수 있음.
- 상황에 따라 맞는 도구를 선택할 수 있음.
